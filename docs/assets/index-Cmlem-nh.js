import{d as P,o as S,b as j,f as b,r as T,y as B,J as D,a7 as y,Z as U,a8 as G,a9 as l,k as p,ad as J,$ as R,a0 as q,G as g,m as z,_ as F,A as H,ab as Q}from"./vue-D4H2Ux2Y.js";import{u as X}from"./use-lifecycle-CyVQVRUS.js";import{m as Y,g as ee,a as Z,e as w}from"./map-BNjwlB2H.js";import{u as ne,l as ie,_ as te}from"./entry/index-BNp4bmLj-1732066199007.js";import"./antd-DgCI0x_J.js";const ae=["onDblclick"],oe={key:0,class:"tree-slider"},de=P({__name:"index",setup(se){const{activate:O,disable:k,currentWidget:A}=ne();S(()=>{L()}),j(()=>{k("layer-tree")}),X(Y),A.onUpdate(()=>{u.value=[],x.value=[],h.value=[],L()});const u=b([]),x=b([]),h=b([]),r={},_=T({});let C;const N=(o,a)=>{var n,i,t;const e=r[a.node.id];if(e){if(e.isAdded||Z(e),(n=e.options)!=null&&n.radio&&a.checked)for(const c in r){const d=r[c];h.value.forEach((s,f)=>{d===r[s]&&e.pid===r[s].pid&&d!==e&&(h.value.splice(f,1),d.show=!1)})}(i=e.options)!=null&&i.onWidget&&(a.checked?(C&&k(C),O({name:e.options.onWidget}),C=e.options.onWidget):k(e.options.onWidget)),a.node.children&&a.node.children.length&&I(o,a.node.children),o.indexOf(a.node.id)!==-1?(e.show=!0,e.options.noCenter||e.readyPromise.then(function(c){c.flyTo({scale:2})})):e.show=!1,(t=e.options)!=null&&t.scenetree&&K(e)}};function I(o,a){a.forEach(e=>{const n=r[e.id];n&&(n.isAdded||Z(n),o.indexOf(e.id)!==-1?n.show=!0:n.show=!1,e.children&&I(o,e.children),n.options.scenetree&&K(n))})}const $=o=>{const a=o.id,e=r[a];e&&(e.opacity=_[a]/100)},V=(o,a)=>{const e=o.parent,n=o.index;switch(a){case"1":{let i=n;for(e.children[0].index=n,e.children[n].index=0;i>0;)w(e.children[n].id,e.children[i-1].id),i--;break}case"2":{e.children[n-1].index=n,e.children[n].index=n-1,w(e.children[n].id,e.children[n-1].id);break}case"3":{e.children[n+1].index=n,e.children[n].index=n+1,w(e.children[n].id,e.children[n+1].id);break}case"4":{let i=n;for(e.children[e.children.length-1].index=n,e.children[n].index=e.children.length-1;i<e.children.length-1;)w(e.children[n].id,e.children[i+1].id),i++;break}}e.children=e.children.sort((i,t)=>i.index-t.index)};function M(o){o.checked&&r[o.id].flyTo()}const m=[];function L(){const o=ee();o.forEach(i=>{(i.pid===""||!i.pid)&&(i.pid=-1),i.pid===-1&&i.type!=="group"&&m.push(i)});for(let i=0;i<m.length;i++){const t=m[i],c=m[i+1];o.some(d=>(c&&t.id!==d.pid&&c.id!==d.pid&&d.pid!==-1&&(d.pid=-1),null))}for(let i=o.length-1;i>=0;i--){const t=o[i];if(t==null||!t.options||t.isPrivate||t.parent)continue;const c=t.options;if(!(!c.name||c.name==="未命名")&&(r[t.id]=t,t&&t.pid===-1)){const d=T({index:i,title:t.name||`未命名(${t.type})`,key:t.id,id:t.id,pId:t.pid,hasZIndex:t.hasZIndex,hasOpacity:t.hasOpacity,opacity:100*(t.opacity||0)});t.hasOpacity&&(_[t.id]=100*(t.opacity||0)),d.children=E(d,o),u.value.push(d),t.options.open!==!1&&x.value.push(d.key),t.isAdded&&t.show&&B(()=>{h.value.push(d.key)})}}u.value.forEach(i=>{i.children.forEach(t=>{t.children&&t.children.forEach(c=>{r[c.key].options.radio&&(c.parent.disabled=!0)})})});const a=ie.cloneDeep(D(u.value)),e=a[a.length-1],n=a.splice(0,a.length-1).reverse();u.value=[...n,D(e)]}function E(o,a){return a.filter(e=>{if(e==null||!e.options||e.isPrivate||e.parent)return!1;const n=e.options;return!n.name||n.name==="未命名"?!1:e.pid===o.id}).reverse().map((e,n)=>{const i={index:n,title:e.name||`未命名(${e.type})`,key:e.id,id:e.id,pId:e.pid,hasZIndex:e.hasZIndex,hasOpacity:e.hasOpacity,opacity:100*(e.opacity||0),parent:o};return e.hasOpacity&&(_[e.id]=100*(e.opacity||0)),r[e.id]=e,i.children=E(i,a),e.options.open!==!1&&x.value.push(i.key),e.isAdded&&e.show&&B(()=>{h.value.push(i.key)}),i})}function K(o){k("layer-tree"),v&&(v.off("click",W),v=null),o.options.scenetree&&(o.on("click",W),v=o)}let v;function W(o){const a=o.layer,e=a.options.url,n=a.id;O({name:"layer-tree",data:{url:e,id:n}})}return(o,a)=>{const e=y("a-menu-item"),n=y("a-menu"),i=y("mars-dropdown-menu"),t=y("mars-slider"),c=y("mars-tree"),d=y("mars-dialog");return U(),G(d,{draggable:!0,title:"图层",width:"340","min-width":260,top:"60",right:"10"},{default:l(()=>[p(c,{checkable:"","tree-data":u.value,expandedKeys:x.value,"onUpdate:expandedKeys":a[0]||(a[0]=s=>x.value=s),checkedKeys:h.value,"onUpdate:checkedKeys":a[1]||(a[1]=s=>h.value=s),onCheck:N},{title:l(s=>[p(i,{trigger:["contextmenu"]},J({default:l(()=>[R("span",{onDblclick:f=>M(s)},q(s.title),41,ae)]),_:2},[s.hasZIndex?{name:"overlay",fn:l(()=>[p(n,{onClick:f=>V(s,f.key)},{default:l(()=>[p(e,{key:"1"},{default:l(()=>[g("图层置为顶层")]),_:1}),p(e,{key:"2"},{default:l(()=>[g("图层上移一层")]),_:1}),p(e,{key:"3"},{default:l(()=>[g("图层下移一层")]),_:1}),p(e,{key:"4"},{default:l(()=>[g("图层置为底层")]),_:1})]),_:2},1032,["onClick"])]),key:"0"}:void 0]),1024),s.hasOpacity?z((U(),F("span",oe,[p(t,{value:_[s.id],"onUpdate:value":f=>_[s.id]=f,min:0,step:1,max:100,onChange:f=>$(s)},null,8,["value","onUpdate:value","onChange"])],512)),[[H,s.checked]]):Q("",!0)]),_:1},8,["tree-data","expandedKeys","checkedKeys"])]),_:1})}}}),fe=te(de,[["__scopeId","data-v-47806e4c"]]);export{fe as default};
